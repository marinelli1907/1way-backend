<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up(): void
    {
        // 1) Rename old LONGTEXT coordinates -> coordinates_json (if it exists and coordinates_json doesn't)
        if (Schema::hasTable('zones')) {
            $columns = Schema::getColumnListing('zones');

            if (in_array('coordinates', $columns) && !in_array('coordinates_json', $columns)) {
                Schema::table('zones', function (Blueprint $table) {
                    $table->renameColumn('coordinates', 'coordinates_json');
                });
            }

            // 2) Add GEOMETRY column named coordinates if missing
            $columns = Schema::getColumnListing('zones');
            if (!in_array('coordinates', $columns)) {
                // MySQL spatial column (POLYGON)
                DB::statement("ALTER TABLE zones ADD COLUMN coordinates GEOMETRY NULL AFTER coordinates_json");
            }
        }
    }

    public function down(): void
    {
        if (!Schema::hasTable('zones')) return;

        $columns = Schema::getColumnListing('zones');

        if (in_array('coordinates', $columns)) {
            DB::statement("ALTER TABLE zones DROP COLUMN coordinates");
        }

        if (in_array('coordinates_json', $columns) && !in_array('coordinates', $columns)) {
            Schema::table('zones', function (Blueprint $table) {
                $table->renameColumn('coordinates_json', 'coordinates');
            });
        }
    }
};