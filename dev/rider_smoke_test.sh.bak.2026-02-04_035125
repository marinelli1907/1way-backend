#!/usr/bin/env bash
set -e

BASE_URL="https://api.1wayride.com"
PHONE="15555550123"
PASSWORD="password"

echo "== Rider Smoke Test =="

echo "1) Logging in..."
LOGIN_JSON=$(curl -sS -X POST "$BASE_URL/api/customer/auth/login" \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -d "{
    \"phone_or_email\": \"$PHONE\",
    \"password\": \"$PASSWORD\",
    \"fcm_token\": \"dev-test\"
  }")

TOKEN=$(echo "$LOGIN_JSON" | php -r '
$j=json_decode(stream_get_contents(STDIN),true);
echo $j["data"]["token"] ?? "";
')

if [ -z "$TOKEN" ]; then
  echo "‚ùå Login failed"
  echo "$LOGIN_JSON"
  exit 1
fi

echo "‚úÖ Login OK"

echo "2) Creating ride..."
CREATE_JSON=$(curl -sS -X POST "$BASE_URL/api/customer/ride/create" \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "bid": 0,
    "zone_id": 2,
    "vehicle_category_id": "80787aa9-10b4-4af5-81a8-6c79a8acf154",
    "pickup_latitude": 41.4993,
    "pickup_longitude": -81.6944,
    "destination_latitude": 41.5000,
    "destination_longitude": -81.7000,
    "type": "ride_request",
    "estimated_fare": 10,
    "payment_method": "cash"
  }')

TRIP_ID=$(echo "$CREATE_JSON" | php -r '
$j=json_decode(stream_get_contents(STDIN),true);
echo $j["data"]["id"] ?? "";
')

if [ -z "$TRIP_ID" ]; then
  echo "‚ùå Ride creation failed"
  echo "$CREATE_JSON"
  exit 1
fi

echo "‚úÖ Ride created: $TRIP_ID"

echo "3) Cancelling ride..."
CANCEL_JSON=$(curl -sS -X PUT "$BASE_URL/api/customer/ride/update-status/$TRIP_ID" \
  -H "Accept: application/json" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "status": "cancelled",
    "cancel_reason": "smoke test"
  }')

echo "$CANCEL_JSON" | php -r '
$j=json_decode(stream_get_contents(STDIN),true);
if (!isset($j["response_code"])) {
  echo "‚ùå Cancel failed\n";
  print_r($j);
  exit(1);
}
echo "‚úÖ Cancel response OK\n";
'

echo ""
echo "üéâ RIDER SMOKE TEST PASSED"

